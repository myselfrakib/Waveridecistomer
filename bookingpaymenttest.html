<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WaveRide - Book Your Ride</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      color: #333;
      padding-bottom: 80px;
    }
    .container {
      max-width: 500px;
      margin: 20px auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    select, input, button {
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      border: none;
    }
    .bike-card {
      background: #f8f9fa;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      text-align: center;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .bottom-nav a {
      text-decoration: none;
      color: #555;
      font-size: 14px;
      text-align: center;
    }
    .bottom-nav i {
      font-size: 20px;
      display: block;
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Book Your Ride</h2>

  <form id="bookingForm">
    <label>Category:</label>
    <select id="category" required>
      <option value="">Select Category</option>
      <option value="Scooter">Scooter</option>
      <option value="Bikes under 150cc">Bikes under 150cc</option>
      <option value="Premium">Premium</option>
    </select>

    <label>Pickup Date:</label>
    <input type="date" id="pickupDate" required min="">

    <label>Pickup Time:</label>
    <select id="pickupTime" required></select>

    <label>Duration:</label>
    <select id="duration" required>
      <option value="3">3 HRS</option>
      <option value="6">6 HRS</option>
      <option value="24">1 DAY</option>
      <option value="168">7 DAYS</option>
      <option value="720">30 DAYS</option>
    </select>

    <button type="submit">Check Availability</button>
  </form>

  <div id="bikeList"></div>
</div>

<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i>Home</a>
  <a href="booking.html" class="active"><i class="fas fa-motorcycle"></i>Book</a>
  <a href="mybookings.html"><i class="fas fa-list"></i>Bookings</a>
  <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHKD70OH34uj7yA0tjBtQZuDbRcRiFins",
  authDomain: "waveride-bike-rental-service.firebaseapp.com",
  databaseURL: "https://waveride-bike-rental-service-default-rtdb.firebaseio.com",
  projectId: "waveride-bike-rental-service",
  storageBucket: "waveride-bike-rental-service.appspot.com",
  messagingSenderId: "341920732961",
  appId: "1:341920732961:web:3967e19131f8984f0f1060"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();

const pickupTimeSelect = document.getElementById("pickupTime");
for (let hour = 8; hour <= 23; hour++) {
  ["00", "30"].forEach(min => {
    const time = new Date();
    time.setHours(hour);
    time.setMinutes(min);
    const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
    const option = document.createElement("option");
    option.value = `${hour}:${min}`;
    option.text = timeStr;
    pickupTimeSelect.appendChild(option);
  });
}

document.getElementById("pickupDate").min = new Date().toISOString().split("T")[0];

document.getElementById("bookingForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const category = document.getElementById("category").value;
  const pickupDate = document.getElementById("pickupDate").value;
  const pickupTime = document.getElementById("pickupTime").value;
  const duration = parseInt(document.getElementById("duration").value);

  if (!category || !pickupDate || !pickupTime || !duration) {
    alert("Please fill all fields!");
    return;
  }

  const [hour, minute] = pickupTime.split(":");
  const pickupDateTime = new Date(`${pickupDate}T${hour.padStart(2, '0')}:${minute}:00`);
  const dropoffDateTime = new Date(pickupDateTime.getTime() + duration * 60 * 60 * 1000);

  const vehicleSnap = await get(child(ref(db), `vehicles/${category}`));
  const fareSnap = await get(child(ref(db), `fareRules`));

  if (vehicleSnap.exists()) {
    const vehicles = vehicleSnap.val();
    const fares = fareSnap.exists() ? fareSnap.val() : {};

    const bikeList = document.getElementById("bikeList");
    bikeList.innerHTML = "";

    Object.keys(vehicles).forEach(bikeName => {
      const bike = vehicles[bikeName];
      if (bike.isActive && bike.status === "enabled") {
        const baseFare = fares[bikeName]?.durations?.[duration] || 300; // default fallback
        bikeList.innerHTML += `
          <div class="bike-card">
            <strong>${bikeName}</strong><br>
            Fare: â‚¹${baseFare}<br>
            <button onclick="proceedPayment('${bikeName}', '${pickupDateTime.toISOString()}', '${dropoffDateTime.toISOString()}', ${baseFare})">Book Now</button>
          </div>
        `;
      }
    });
  } else {
    alert("No vehicles available right now.");
  }
});

window.proceedPayment = (bikeName, pickupISO, dropoffISO, fare) => {
  localStorage.setItem("pendingBooking", JSON.stringify({
    bikeName, pickupISO, dropoffISO, fare
  }));
  window.location.href = "payment.html";
};
</script>
</body>
</html>
