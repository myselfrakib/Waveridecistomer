<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WaveRide - Book Your Ride</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #4facfe, #00f2fe);
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 600px;
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .bike-item {
      background: #f1f1f1;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    h2, h4 {
      color: #007bff;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center">WaveRide Booking</h2>
  <form id="bookingForm">
    <label for="category">Select Category</label>
    <select id="category" class="form-select" required>
      <option value="">Loading categories...</option>
    </select>

    <label for="pickupDate">Pickup Date</label>
    <input type="date" id="pickupDate" class="form-control" required>

    <label for="pickupTime">Pickup Time</label>
    <select id="pickupTime" class="form-select" required></select>

    <label for="duration">Duration</label>
    <select id="duration" class="form-select" required>
      <option value="3">3 HRS</option>
      <option value="6">6 HRS</option>
      <option value="24">1 DAY</option>
      <option value="168">7 DAYS</option>
      <option value="720">30 DAYS</option>
    </select>

    <button type="submit" class="btn btn-primary w-100 mt-3">Check Availability</button>
  </form>

  <div id="bikeList" class="mt-4"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBHKD70OH34uj7yA0tjBtQZuDbRcRiFins",
    authDomain: "waveride-bike-rental-service.firebaseapp.com",
    databaseURL: "https://waveride-bike-rental-service-default-rtdb.firebaseio.com",
    projectId: "waveride-bike-rental-service",
    storageBucket: "waveride-bike-rental-service.appspot.com",
    messagingSenderId: "341920732961",
    appId: "1:341920732961:web:3967e19131f8984f0f1060"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  const pickupTime = document.getElementById("pickupTime");
  for (let hour = 8; hour <= 23; hour++) {
    ["00", "30"].forEach(min => {
      const date = new Date();
      date.setHours(hour);
      date.setMinutes(min);
      const formatted = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
      const option = document.createElement("option");
      option.value = `${hour}:${min}`;
      option.text = formatted;
      pickupTime.appendChild(option);
    });
  }

  const today = new Date().toISOString().split("T")[0];
  document.getElementById("pickupDate").min = today;

  const categorySelect = document.getElementById("category");
  onValue(ref(db, "vehicles"), snapshot => {
    const categories = snapshot.val();
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    for (let cat in categories) {
      categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    }
  });

  document.getElementById("bookingForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const category = categorySelect.value;
    const date = document.getElementById("pickupDate").value;
    const time = document.getElementById("pickupTime").value;
    const duration = parseInt(document.getElementById("duration").value);
    const [hour, minute] = time.split(":");

    const pickupDateTime = new Date(`${date}T${hour.padStart(2, '0')}:${minute}`);
    const dropoffDateTime = new Date(pickupDateTime.getTime() + duration * 60 * 60 * 1000);

    const bikeListDiv = document.getElementById("bikeList");
    bikeListDiv.innerHTML = "<h4>Checking availability...</h4>";

    const vehiclesRef = ref(db, `vehicles/${category}`);
    onValue(vehiclesRef, async (snapshot) => {
      const bikes = snapshot.val() || {};
      let available = [];

      for (const model in bikes) {
        const status = bikes[model].status;
        if (status !== "available") continue;

        const bookingRef = ref(db, `bookings/${model}`);
        let isAvailable = true;

        await new Promise(res => {
          onValue(bookingRef, (snap) => {
            snap.forEach(b => {
              const val = b.val();
              const existingStart = new Date(val.pickup);
              const existingEnd = new Date(val.dropoff);
              if (pickupDateTime < existingEnd && dropoffDateTime > existingStart) {
                isAvailable = false;
              }
            });
            res();
          }, { onlyOnce: true });
        });

        if (isAvailable) {
          const fareRef = ref(db, `fareRules/${model}`);
          let fareDisplay = "Fare not set";
          await new Promise(res => {
            onValue(fareRef, snap => {
              const rule = snap.val();
              if (rule && rule.durations && rule.from && rule.to) {
                const from = new Date(rule.from);
                const to = new Date(rule.to);
                if (pickupDateTime >= from && pickupDateTime <= to) {
                  fareDisplay = "â‚¹" + (rule.durations[duration] || "N/A");
                }
              }
              res();
            }, { onlyOnce: true });
          });

          available.push({ model, fareDisplay });
        }
      }

      if (available.length > 0) {
        bikeListDiv.innerHTML = "<h4>Available Vehicles</h4>" + available.map(b => `
          <div class="bike-item">
            <strong>${b.model}</strong><br>
            Fare: ${b.fareDisplay}<br>
            <button class="btn btn-success mt-2" onclick="bookNow('${b.model}', '${pickupDateTime.toISOString()}', '${dropoffDateTime.toISOString()}', ${duration}, '${b.fareDisplay}')">Book Now</button>
          </div>
        `).join("");
      } else {
        bikeListDiv.innerHTML = "<p>No vehicles available in this category and time slot.</p>";
      }
    }, { onlyOnce: true });
  });

  window.bookNow = function (model, pickup, dropoff, duration, fare) {
    onAuthStateChanged(auth, user => {
      if (!user) return alert("You must be logged in.");
      const bookingRef = push(ref(db, `bookings/${model}`));
      set(bookingRef, {
        user: user.uid,
        pickup,
        dropoff,
        duration,
        fare,
        status: "booked"
      }).then(() => {
        alert("Booking successful!");
        window.location.href = "success.html";
      });
    });
  };
</script>
</body>
</html>
