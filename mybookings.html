<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Bookings - WaveRide</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #4facfe, #00f2fe);
    }

    nav {
      background-color: #003366;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      color: white;
    }

    nav h1 {
      font-size: 22px;
      margin: 0;
    }

    .nav-links {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 5px;
    }

    .nav-links a:hover,
    .nav-links a.active {
      background-color: #0059b3;
    }

    .container {
      max-width: 600px;
      margin: 20px auto;
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #007bff;
    }

    .booking {
      background: #f1f1f1;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .booking p {
      margin: 6px 0;
    }

    .btn-cancel {
      background: #ff4d4d;
      border: none;
      padding: 10px;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-cancel:hover {
      background: #cc0000;
    }

    .no-bookings {
      text-align: center;
      color: #666;
      margin-top: 30px;
    }

    @media (max-width: 600px) {
      .container {
        margin: 10px;
      }

      .nav-links {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<nav>
  <h1>WaveRide</h1>
  <div class="nav-links">
    <a href="home.html">Home</a>
    <a href="booking.html">Book a Ride</a>
    <a href="mybookings.html" class="active">My Bookings</a>
    <a href="profile.html">Profile</a>
    <a href="#" onclick="logoutUser()">Logout</a>
  </div>
</nav>

<div class="container">
  <h2>My Bookings</h2>
  <div id="bookingList" class="booking-list"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBHKD70OH34uj7yA0tjBtQZuDbRcRiFins",
    authDomain: "waveride-bike-rental-service.firebaseapp.com",
    projectId: "waveride-bike-rental-service",
    storageBucket: "waveride-bike-rental-service.firebasestorage.app",
    messagingSenderId: "341920732961",
    appId: "1:341920732961:web:3967e19131f8984f0f1060",
    measurementId: "G-59M75TD99E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  const bookingList = document.getElementById("bookingList");

  const durationFareMap = {
    3: 150,
    6: 300,
    24: 500,
    168: 3000,
    720: 8500
  };

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      bookingList.innerHTML = "<p class='no-bookings'>You must be logged in to see bookings.</p>";
      return;
    }

    const uid = user.uid;
    let found = false;

    onValue(ref(db, "bookings"), (snapshot) => {
      bookingList.innerHTML = "";
      snapshot.forEach(bike => {
        const bikeName = bike.key;

        bike.forEach(entry => {
          const data = entry.val();
          if (data.user === uid) {
            found = true;

            const pickup = new Date(data.pickup);
            const dropoff = new Date(data.dropoff);
            const durationHours = Math.round((dropoff - pickup) / (1000 * 60 * 60));
            const fare = durationFareMap[durationHours] || "N/A";

            const div = document.createElement("div");
            div.className = "booking";
            div.innerHTML = `
              <p><strong>Bike:</strong> ${bikeName}</p>
              <p><strong>Pickup:</strong> ${pickup.toLocaleString()}</p>
              <p><strong>Drop-off:</strong> ${dropoff.toLocaleString()}</p>
              <p><strong>Duration:</strong> ${durationHours} Hrs</p>
              <p><strong>Fare:</strong> â‚¹${fare}</p>
              <button class="btn-cancel" onclick="cancelBooking('${bikeName}', '${entry.key}')">Cancel Booking</button>
            `;
            bookingList.appendChild(div);
          }
        });
      });

      if (!found) {
        bookingList.innerHTML = "<p class='no-bookings'>No bookings found.</p>";
      }
    });
  });

  window.cancelBooking = function(bike, bookingId) {
    if (confirm("Are you sure you want to cancel this booking?")) {
      remove(ref(db, `bookings/${bike}/${bookingId}`))
        .then(() => alert("Booking canceled."))
        .catch(err => alert("Error cancelling: " + err));
    }
  };

  window.logoutUser = function() {
    signOut(auth).then(() => {
      window.location.href = "index.html";
    }).catch((error) => {
      alert("Logout failed: " + error.message);
    });
  }
</script>

</body>
</html>
